version: 2.1

# 1. Define the Jira Orb for integration
orbs:
  jira: circleci/jira@2.2.0
  node: circleci/node@5.1.0

jobs:
  build_and_test:
    docker:
      - image: cimg/node:20.10.0
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: ~/project/pis-platform
      - run:
          name: Run Build
          command: |
            cd pis-platform
            npm run build
      # Uncomment if you have tests
      # - run:
      #     name: Run Tests
      #     command: npm test
      # This notifies Jira of the build status
      - jira/notify:
          pipeline_id: << pipeline.id >>
          pipeline_number: << pipeline.number >>
          webhook_url: "https://128227a1-b1f0-4c2b-b7b6-1b32a1afee83.hello.atlassian-dev.net/x1/HoNpDOdk335SoAoWQfbXe76UeFY"
      # This moves the ticket to a new status (e.g., "Done" or "In Review")
      # - jira/transition:
      #     transition-id: "Done" # Use the exact name or ID from Jira
      #     status-filter: "In Progress" # Only move if it's currently In Progress

  deploy:
    docker:
      - image: cimg/node:20.10.0
    steps:
      - checkout
      - run:
          name: Deploy to Production
          command: echo "Deploying to prod..." # Replace with actual deploy command
      - jira/notify:
          pipeline_id: << pipeline.id >>
          pipeline_number: << pipeline.number >>
          webhook_url: "https://128227a1-b1f0-4c2b-b7b6-1b32a1afee83.hello.atlassian-dev.net/x1/HoNpDOdk335SoAoWQfbXe76UeFY"

workflows:
  version: 2
  development_pipeline:
    jobs:
      - build_and_test
      - deploy:
          requires:
            - build_and_test
          filters:
            branches:
              only: main # Deploy only happens after the PR is merged
